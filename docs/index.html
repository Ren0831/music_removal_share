<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Music Removal - Listening Samples</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; margin: 20px; line-height: 1.6; }
    h1 { font-size: 1.4rem; margin-bottom: 0.25rem; }
    .small { color: #666; font-size: 0.9rem; }
    .row { display: flex; gap: 16px; align-items: flex-start; flex-wrap: wrap; margin-top: 10px; }
    .panel { border: 1px solid #eee; border-radius: 10px; padding: 12px; }
    .panel .label { font-weight: 700; margin-bottom: 6px; }
    .qr img { max-width: 220px; width: 220px; height: auto; display: block; }
    .controls { min-width: 280px; }
    select { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd; }
    .meta { margin-top: 8px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 18px; margin-top: 14px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; }
    .card .label { font-weight: 600; margin-bottom: 6px; }
    audio { width: 100%; margin-top: 8px; }
    .error { color: #b00020; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
  </style>
</head>
<body>
  <h1>Music Removal - Listening Samples</h1>
  <div class="small">
    右のQRからスマホで開けます。左のプルダウンで「いつ出力した音源（セット）」を選び、各音源が何か（Mixture/Target/Outputなど）をラベルで確認しながら再生できます。
  </div>

  <div class="row">
    <div class="panel controls">
      <div class="label">Choose a set (出力タイミング)</div>
      <select id="setSelect" aria-label="Choose a set"></select>
      <div id="setMeta" class="meta small"></div>
      <div class="small" style="margin-top:10px;">
        定義:
        Mixture=入力混合 / Target=環境音GT / Baseline=ベースモデル出力 / MetricGAN+=品質補正あり / Distillation=蒸留あり
      </div>
      <div class="small" style="margin-top:10px;">
        manifest: <a href="manifest.json">manifest.json</a>
      </div>
    </div>

    <div class="panel qr">
      <div class="label">QR (All Samples)</div>
      <img src="qr/all_samples.png" alt="QR code to open this page" />
      <div class="small"><a href="qr/all_samples.png">Open QR image</a></div>
    </div>
  </div>

  <div id="error" class="error small" style="margin-top:12px;"></div>
  <div id="cards" class="grid" aria-live="polite"></div>

  <script>
    const $ = (id) => document.getElementById(id);

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll("\"", "&quot;")
        .replaceAll("'", "&#039;");
    }

    function renderSet(set) {
      $("setMeta").innerHTML =
        `<div><b>${escapeHtml(set.title || set.id)}</b></div>` +
        (set.date ? `<div>${escapeHtml(set.date)}</div>` : "") +
        (set.description ? `<div>${escapeHtml(set.description)}</div>` : "");

      const items = Array.isArray(set.items) ? set.items : [];
      $("cards").innerHTML = items.map((it) => {
        const label = escapeHtml(it.label || it.path || "Audio");
        const path = escapeHtml(it.path || "");
        return `
          <div class="card">
            <div class="label">${label}</div>
            <audio controls preload="none" src="${path}"></audio>
            <div class="small"><a href="${path}">Open file</a></div>
          </div>
        `;
      }).join("");
    }

    async function main() {
      try {
        const resp = await fetch("manifest.json?v=20251223T050409Z", { cache: "no-store" });
        if (!resp.ok) throw new Error(`manifest load failed: ${resp.status}`);
        const manifest = await resp.json();

        const sets = Array.isArray(manifest.sets) ? manifest.sets : [];
        if (sets.length === 0) throw new Error("No sets found in manifest");

        const sel = $("setSelect");
        sel.innerHTML = sets.map((s) => {
          const title = s.title ? `${s.title}` : s.id;
          const date = s.date ? ` (${s.date})` : "";
          return `<option value="${escapeHtml(s.id)}">${escapeHtml(title + date)}</option>`;
        }).join("");

        const byId = new Map(sets.map((s) => [s.id, s]));
        const initialId = manifest.latest_set_id && byId.has(manifest.latest_set_id)
          ? manifest.latest_set_id
          : sets[0].id;

        sel.value = initialId;
        renderSet(byId.get(initialId));

        sel.addEventListener("change", () => {
          const s = byId.get(sel.value);
          if (s) renderSet(s);
        });
      } catch (e) {
        $("error").textContent = `Error: ${e && e.message ? e.message : e}`;
      }
    }

    main();
  </script>
</body>
</html>
