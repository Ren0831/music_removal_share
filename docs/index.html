<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>音楽除去 サンプル音源まとめ</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; margin: 20px; line-height: 1.6; }
    h1 { font-size: 1.4rem; margin-bottom: 0.25rem; }
    .small { color: #666; font-size: 0.9rem; }
    .row { display: flex; gap: 16px; align-items: stretch; flex-wrap: wrap; margin-top: 10px; }
    .panel { border: 1px solid #eee; border-radius: 10px; padding: 12px; background: #fff; }
    .panel .label { font-weight: 700; margin-bottom: 6px; }
    .left { min-width: 320px; flex: 1 1 320px; }
    .right { flex: 2 1 520px; }
    select { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 18px; margin-top: 14px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; }
    .card .label { font-weight: 600; margin-bottom: 6px; }
    audio { width: 100%; margin-top: 8px; }
    .error { color: #b00020; }
    .langOverlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255, 255, 255, 0.95); z-index: 1000;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      gap: 20px;
    }
    .langOverlay.hidden { display: none; }
    .langBtn {
      padding: 16px 32px; font-size: 1.2rem; border: 2px solid #2d6cdf;
      border-radius: 8px; background: #fff; cursor: pointer;
      transition: background 0.2s;
    }
    .langBtn:hover { background: #eef4ff; }
    .mainContent { display: none; }
    .mainContent.visible { display: block; }
    .langRow { margin-bottom: 18px; }
    .programTabs { display: flex; gap: 8px; margin-top: 4px; margin-bottom: 16px; flex-wrap: wrap; }
    .programTab {
      padding: 10px 18px; border: 1px solid #ccc; border-radius: 8px; background: #f5f5f5;
      cursor: pointer; font-weight: 600;
    }
    .programTab:hover { background: #eee; }
    .programTab.active { background: #2d6cdf; color: #fff; border-color: #2d6cdf; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
  </style>
</head>
<body>
  <div id="langOverlay" class="langOverlay">
    <div style="font-size: 1.3rem; margin-bottom: 10px;">言語を選択 / Select Language</div>
    <button class="langBtn" data-lang="ja">日本語</button>
    <button class="langBtn" data-lang="en">English</button>
  </div>

  <div id="mainContent" class="mainContent">
    <h1 id="pageTitle">音楽除去 サンプル音源まとめ</h1>
    <div id="pageIntro" class="small">音楽除去実験で出力した音源が視聴できます。プログラムごとに最新と比較用の約2本の出力を表示します。</div>
    <div class="langRow small" style="margin-top:10px;">
      <label for="langSelect">Language:</label>
      <select id="langSelect" aria-label="Language">
        <option value="ja">日本語</option>
        <option value="en">English</option>
      </select>
    </div>

    <div id="programLabel" class="small" style="margin-bottom:4px;">手法を選択</div>
    <div id="programTabs" class="programTabs" role="tablist"></div>
    <div id="programDescription" class="small" style="margin-top:-2px; margin-bottom:8px;"></div>
    <div id="error" class="error small" style="margin-top:8px;"></div>
    <div id="cards" class="grid" aria-live="polite" style="margin-top:12px;"></div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll("\"", "&quot;")
        .replaceAll("'", "&#039;");
    }

    const I18N = {
      ja: {
        pageTitle: "音楽除去 サンプル音源まとめ",
        pageIntro: "音楽除去実験で出力した音源が視聴できます。プログラムごとに最新と比較用の約2本の出力を表示します。",
        outputLatest: "最新出力",
        outputComparison: "比較用出力",
        programLabel: "手法を選択",
        programDescriptions: {
          MR: "日常の音から音楽をできるだけ取り除き、まわりの環境音を聞きやすくした結果です。",
          BD: "逆拡散モデルを用いて音の時間的な変化を学習し、音楽だけを少しずつ取り除いて周囲の音を残した結果です。",
          TEL: "電話のような音声を想定した条件で音楽を減らした結果です。",
          default: "この手法で音楽を減らした結果です。"
        },
        labelsByKind: {
          mixture: "混合音源",
          target: "元の環境音",
          output: "出力音源",
          output_old: "出力音源（従来手法）",
          output_new: "出力音源（提案手法）",
          output_no_metricgan: "出力音源（MetricGAN+なし）",
          output_with_metricgan: "出力音源（MetricGAN+あり）",
          output_baseline: "出力音源（Baseline）",
          output_improved: "出力音源（改善版）"
        }
      },
      en: {
        pageTitle: "Music Removal Sample Audio Collection",
        pageIntro: "You can listen to audio outputs from music removal experiments. Each program shows shared mixture/target and about two outputs (latest and comparison).",
        outputLatest: "Latest output",
        outputComparison: "Comparison output",
        programLabel: "Select method",
        programDescriptions: {
          MR: "Removes as much music as possible from everyday sounds so that surrounding environmental sounds are easier to hear.",
          BD: "Uses a reverse diffusion model that learns how sound changes over time and gradually removes only the music while keeping surrounding sounds.",
          TEL: "Designed for phone-like audio, reducing music while keeping voices easy to understand.",
          default: "Results of this method for reducing music."
        },
        labelsByKind: {
          mixture: "Mixture",
          target: "Target",
          output: "Output",
          output_old: "Output (traditional)",
          output_new: "Output (proposed)",
          output_no_metricgan: "Output (no MetricGAN+)",
          output_with_metricgan: "Output (with MetricGAN+)",
          output_baseline: "Output (baseline)",
          output_improved: "Output (improved)"
        }
      }
    };

    let currentLang = localStorage.getItem("lang") || "ja";
    let manifestData = null;

    // Language selection overlay
    const langOverlay = $("langOverlay");
    const mainContent = $("mainContent");
    
    if (!localStorage.getItem("lang")) {
      langOverlay.classList.remove("hidden");
      mainContent.classList.remove("visible");
    } else {
      langOverlay.classList.add("hidden");
      mainContent.classList.add("visible");
    }

    document.querySelectorAll(".langBtn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const lang = btn.getAttribute("data-lang");
        currentLang = lang;
        localStorage.setItem("lang", lang);
        langOverlay.classList.add("hidden");
        mainContent.classList.add("visible");
        initPage();
      });
    });

    function dateKey(set) {
      const d = (set && set.date) ? String(set.date) : "";
      const m = d.match(/\d{4}-\d{2}-\d{2}/);
      return m ? m[0] : "unknown";
    }

    let sharedBase = { mixture: null, target: null };

    function getOutputItems(set) {
      if (!set || !Array.isArray(set.items)) return [];
      return set.items.filter((it) => {
        const k = (it && it.kind) ? String(it.kind) : "";
        return k === "output" || k.startsWith("output_");
      });
    }

    function pickLatestAndComparisonOutputs(setsForProgram) {
      if (!setsForProgram || setsForProgram.length === 0) return [];
      const sorted = [...setsForProgram].sort((a, b) => {
        const da = dateKey(a);
        const db = dateKey(b);
        if (da === "unknown" && db === "unknown") return 0;
        if (da === "unknown") return 1;
        if (db === "unknown") return -1;
        return da > db ? -1 : (da < db ? 1 : 0);
      });
      const latestSet = sorted[0];
      const comparisonSet = sorted.length > 1 ? sorted[1] : null;
      const outLatest = getOutputItems(latestSet);
      const outComp = comparisonSet ? getOutputItems(comparisonSet) : [];
      const preferKind = (it) => {
        const k = String(it.kind || "");
        if (k === "output_improved" || k === "output_with_metricgan") return 2;
        if (k === "output_new") return 2;
        if (k.indexOf("distill") >= 0 || (it.path && it.path.toLowerCase().indexOf("distill") >= 0)) return 2;
        if (k === "output_baseline" || k === "output_no_metricgan") return 0;
        if (k === "output_old") return 0;
        return 1;
      };
      outLatest.sort((a, b) => preferKind(b) - preferKind(a));
      outComp.sort((a, b) => preferKind(b) - preferKind(a));
      const latestItem = outLatest[0] || null;
      let comparisonItem = null;
      if (outLatest.length >= 2) comparisonItem = outLatest[1];
      else if (outComp.length >= 1) comparisonItem = outComp[0];
      const result = [];
      if (latestItem) result.push(latestItem);
      if (comparisonItem && comparisonItem !== latestItem) result.push(comparisonItem);
      return result;
    }

    function renderSingleCard(labelText, path) {
      if (!path) return "";
      return `
        <div class="card">
          <div class="label">${escapeHtml(labelText)}</div>
          <audio controls preload="none" src="${escapeHtml(path)}"></audio>
        </div>
      `;
    }

    function updateProgramDescription(programName) {
      const box = $("programDescription");
      if (!box) return;
      const descMap = (I18N[currentLang] && I18N[currentLang].programDescriptions) || {};
      const key = (programName && descMap[programName]) ? programName : "default";
      box.textContent = descMap[key] || "";
    }

    function renderProgramPage(programName) {
      const cards = [];
      if (sharedBase.mixture && sharedBase.mixture.path)
        cards.push(renderSingleCard(I18N[currentLang].labelsByKind.mixture, sharedBase.mixture.path));
      if (sharedBase.target && sharedBase.target.path)
        cards.push(renderSingleCard(I18N[currentLang].labelsByKind.target, sharedBase.target.path));

      const setsForProgram = (manifestData.sets || []).filter((s) => (s.program || "MR").trim() === programName);
      const outputs = pickLatestAndComparisonOutputs(setsForProgram);
      if (outputs.length >= 1)
        cards.push(renderSingleCard(I18N[currentLang].outputLatest, outputs[0].path));
      if (outputs.length >= 2)
        cards.push(renderSingleCard(I18N[currentLang].outputComparison, outputs[1].path));

      $("cards").innerHTML = cards.join("");
      updateProgramDescription(programName);
    }

    function applyLang() {
      const t = I18N[currentLang];
      $("pageTitle").textContent = t.pageTitle;
      $("pageIntro").textContent = t.pageIntro;
      $("langSelect").value = currentLang;
      const pl = $("programLabel");
      if (pl && t.programLabel) pl.textContent = t.programLabel;
    }

    function setError(msg) {
      const el = $("error");
      if (el) el.textContent = msg;
    }

    async function initPage() {
      try {
        setError("");
        const resp = await fetch("manifest.json?ts=" + Date.now(), { cache: "no-store" });
        if (!resp.ok) throw new Error("manifest load failed: " + resp.status);
        manifestData = await resp.json();

        const sets = Array.isArray(manifestData && manifestData.sets) ? manifestData.sets : [];
        if (sets.length === 0) throw new Error("No sets found in manifest");

        sharedBase = { mixture: null, target: null };
        for (const s of sets) {
          if (!s || !Array.isArray(s.items)) continue;
          const mix = s.items.find((it) => it && String(it.kind || "") === "mixture") || null;
          const tgt = s.items.find((it) => it && String(it.kind || "") === "target") || null;
          if (mix && tgt) {
            sharedBase.mixture = mix;
            sharedBase.target = tgt;
            break;
          }
        }

        const programNames = [...new Set(sets.map((s) => (s.program || "MR").trim()).filter(Boolean))].sort();
        const tabContainer = $("programTabs");
        if (!tabContainer) throw new Error("programTabs element not found");
        tabContainer.innerHTML = programNames.map((p) => `<button type="button" class="programTab" role="tab" data-program="${escapeHtml(p)}">${escapeHtml(p)}</button>`).join("");

        let currentProgram = programNames.length ? programNames[0] : null;
        tabContainer.querySelectorAll(".programTab").forEach((btn) => {
          btn.addEventListener("click", () => {
            currentProgram = btn.getAttribute("data-program");
            tabContainer.querySelectorAll(".programTab").forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            renderProgramPage(currentProgram);
          });
        });
        const firstTab = tabContainer.querySelector(".programTab");
        if (firstTab) firstTab.classList.add("active");
        renderProgramPage(currentProgram);

        const langSel = $("langSelect");
        if (langSel) {
          langSel.value = currentLang;
          langSel.addEventListener("change", () => {
            currentLang = langSel.value === "en" ? "en" : "ja";
            localStorage.setItem("lang", currentLang);
            applyLang();
            if (currentProgram) renderProgramPage(currentProgram);
          });
        }
        applyLang();
      } catch (e) {
        setError("Error: " + (e && e.message ? e.message : String(e)));
      }
    }

    if (localStorage.getItem("lang")) {
      initPage();
    }
  </script>
</body>
</html>
